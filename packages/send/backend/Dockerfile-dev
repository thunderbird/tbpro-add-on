FROM node:22.14.0

# Set environment vartiable for runtime container user name
ENV runtime_user=send

RUN apt update -y && apt upgrade -y

WORKDIR /app
ADD package.json \
# We don't copy the lockfile during development 
# because we resolve our dependencies at the root
    # pnpm-lock.yaml \
    tsconfig.json \
    ./
ADD prisma ./prisma
ADD public ./public
ADD scripts ./scripts
ADD src ./src

RUN npm install -g pnpm && \
    pnpm install --no-frozen-lockfile && \
    chown -R node:node /app

# Add runtime user
RUN useradd ${runtime_user} -d /home/${runtime_user}

# Chown /app to runtime_user
RUN chown -Rvf ${runtime_user} /app

# Switch to runtime user
USER ${runtime_user}

CMD ["/bin/sh", "/app/scripts/entry.sh"]